{% load static %}

<div id="editBookModal" class="modal fade" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true"
     data-bs-show="true" hx-target="this" hx-swap="outerHTML">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="editBookModalLabel">
            {% if is_new %}Imported Book{% else %}Edit Book{% endif %}
          </h5>
          {% if book.code %}
          <div class="text-muted small">
            <span class="font-monospace">{{ book.code }}</span>
          </div>
          {% endif %}
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form hx-post="{% url 'edit_book_modal' book.id %}"
            hx-target="closest .modal"
            hx-swap="outerHTML">
        <div class="modal-body">
          {% if error_message %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}

          <div class="mb-3">
            <label for="bookTitle" class="form-label">Title</label>
            <input type="text"
                   class="form-control {% if error_message and not book.title %}is-invalid{% endif %}"
                   id="bookTitle"
                   name="title"
                   value="{{ book.title }}"
                   required>
          </div>

          <div class="mb-3">
            <label for="bookAuthor" class="form-label">Author</label>
            <input type="text"
                   class="form-control {% if error_message and not book.author.name %}is-invalid{% endif %}"
                   id="bookAuthor"
                   name="author"
                   value="{{ book.author.name }}"
                   hx-get="{% url 'search_authors' %}"
                   hx-trigger="keyup changed delay:300ms"
                   hx-target="#authorSuggestions"
                   required>
            <ul id="authorSuggestions" class="list-group mt-2">
              <!-- Author suggestions will be populated here -->
            </ul>
          </div>

          <div class="mb-3">
            <label for="bookLanguage" class="form-label">Language</label>
            <select class="form-select" id="bookLanguage" name="language" required>
              {% for lang in languages %}
              <option value="{{ lang.google_code }}"
                      {% if lang.google_code == book.language.google_code %}selected{% endif %}>
                {{ lang.name }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button"
                  class="btn btn-outline-danger"
                  {% if not is_new %}
                    data-bs-toggle="modal"
                    data-bs-target="#deleteConfirmModal"
                  {% else %}
                    hx-delete="{% url 'edit_book_modal' book.id %}"
                    hx-target="body"
                    hx-swap="none"
                    hx-on::after-request="
                      if(event.detail.successful) {
                        bootstrap.Modal.getInstance(document.getElementById('editBookModal')).hide();
                        htmx.trigger('#booksList', 'refresh')
                      }
                    "
                  {% endif %}
          >
            <i class="bi bi-trash"></i>
          </button>
          <div>
            {% if not is_new %}
            <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Close</button>
            {% endif %}
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-1"></i>Save
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm" style="max-width: 300px">
    <div class="modal-content" style="background-color: rgb(255, 245, 235)">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>Delete Book
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
          <div class="alert alert-warning bg-transparent border-0 mb-0 p-0">
            <p>Are you sure you want to delete "{{ book.title }} ({{ book.code }})"?</p>
            <p class="text-muted small mb-0">This action cannot be undone.</p>
          </div>
      </div>
      <div class="modal-footer border-0">
        {% if not is_new %}
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        {% endif %}
        <button type="button"
                class="btn btn-warning"
                hx-delete="{% url 'edit_book_modal' book.id %}"
                hx-target="body"
                hx-swap="none"
                data-bs-dismiss="modal"
                hx-on::after-request="
                  if(event.detail.successful) {
                    bootstrap.Modal.getInstance(document.getElementById('editBookModal')).hide();
                    htmx.trigger('#booksList', 'refresh')
                  }
                "
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  new bootstrap.Modal(document.getElementById('editBookModal')).show();
</script>
