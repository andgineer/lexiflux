{% extends 'base.html' %}

{% block content %}
<div id="profile-app" class="d-flex flex-column vh-100">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            {% include 'hamburger.html' with current_page='profile' %}
            <div class="mx-3 text-truncate container-fluid">
                Language Tool Preferences
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex align-items-center">
                    <label for="languageSelect" class="form-label me-3 mb-0 text-nowrap">For book language:</label>
                    <select id="languageSelect" v-model="currentLanguageId" @change="changeLanguage" class="form-select">
                        <option v-for="language in allLanguages" :value="language.google_code">
                            [[ language.name ]]
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <h5 class="card-header">Options</h5>
                    <div class="card-body">
                        <div class="mb-3 d-flex align-items-center">
                            <label for="userLanguageSelect" class="form-label me-3 mb-0 text-nowrap">Translate to:</label>
                            <select id="userLanguageSelect" v-model="userLanguageId" @change="changeUserLanguage" class="form-select">
                                <option v-for="language in allLanguages" :value="language.google_code">
                                    [[ language.name ]]
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <strong>In-text translation:</strong>
                                <button type="button" class="btn btn-primary btn-sm" @click="editInlineTranslation">
                                    Edit
                                </button>
                            </div>
                            <div class="mt-2 p-2 bg-light rounded">
                                <div><strong>Type:</strong> [[ inlineTranslation.type ]]</div>
                                <div v-if="inlineTranslation.type === 'Site'">
                                    <div><strong>URL:</strong> [[ formatUrl(inlineTranslation.parameters.url) ]]</div>
                                    <div><strong>in separate window:</strong> [[ inlineTranslation.parameters.window ]]</div>
                                </div>
                                <div v-else-if="inlineTranslation.type === 'Dictionary'">
                                    <div><strong>Dictionary:</strong> [[ inlineTranslation.parameters.dictionary ]]</div>
                                </div>
                                <div v-else v-for="(value, name) in inlineTranslation.parameters" :key="name">
                                    <strong>[[ name ]]:</strong>
                                    <span v-if="name === 'model'">[[ getModelTitle(value) ]]</span>
                                    <span v-else>[[ value ]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h5 class="card-header">
                    Lexical Articles Sidebar
                    <i class="bi bi-binoculars"></i>
                </h5>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center" v-for="article in articles" :key="article.id">
                            <div>
                                <h5 class="mb-1">[[ article.title ]]</h5>
                                <div v-if="article.type === 'Site'">
                                    <div><strong>URL:</strong> [[ formatUrl(article.parameters.url) ]]</div>
                                    <div><strong>in separate window:</strong> [[ article.parameters.window ]]</div>
                                </div>
                                <div v-else-if="article.type === 'Dictionary'">
                                    <div><strong>Dictionary:</strong> [[ article.parameters.dictionary ]]</div>
                                </div>
                                <div v-else v-for="(value, name) in article.parameters" :key="name">
                                    <strong>[[ name ]]:</strong>
                                    <span v-if="name === 'model'">[[ getModelTitle(value) ]]</span>
                                    <span v-else>[[ value ]]</span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary btn-sm" @click="openModal('edit', article)">Edit</button>
                                <button class="btn btn-danger btn-sm" @click="deleteArticle(article.id)">Delete</button>
                            </div>
                        </li>
                    </ul>
                    <button type="button" class="btn btn-primary mb-3" @click="openModal('add')">
                        Add New Article
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing lexical articles and in-line translation -->
    <div class="modal fade" id="articleModal" tabindex="-1" aria-labelledby="articleModalLabel" aria-hidden="true" ref="articleModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ modalTitle }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveArticle">
                        <div class="alert alert-danger" v-if="errorMessage" role="alert">
                            [[ errorMessage ]]
                        </div>
                        <div class="mb-3" v-if="showTitleField">
                            <label for="articleTitle" class="form-label">Title</label>
                            <input type="text" v-model="form.title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="articleType" class="form-label">Article Type</label>
                            <select v-model="form.type" class="form-select" @change="updateParameters">
                                <option value="">Select type</option>
                                <option value="Translate">Translate</option>
                                <option value="Sentence">Sentence</option>
                                <option value="Explain">Explain</option>
                                <option value="Examples">Examples</option>
                                <option value="Lexical">Lexical</option>
                                <option value="Dictionary">Dictionary</option>
                                <option value="Site">Site</option>
                            </select>
                        </div>
                        <div v-if="form.type === 'Site'">
                            <div class="mb-3">
                                <label class="form-label">URL</label>
                                <input type="url" v-model="form.parameters.url" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Predefined URLs</label>
                                <select v-model="form.parameters.url" class="form-select">
                                    <option value="">Select a predefined URL</option>
                                    <option v-for="url in predefinedUrls" :value="url">[[ url ]]</option>
                                </select>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" v-model="form.parameters.window" class="form-check-input">
                                <label class="form-check-label">Open in new window</label>
                            </div>
                        </div>
                        <div v-if="['Translate', 'Sentence', 'Explain', 'Examples', 'Lexical'].includes(form.type)">
                            <div class="mb-3">
                                <label class="form-label">AI Model</label>
                                <select v-model="form.parameters.model" class="form-select">
                                    <option value="">Select model</option>
                                    <option v-for="model in aiModels" :key="model.key" :value="model.key">
                                        [[ model.title ]]
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div v-if="form.type === 'Dictionary'">
                            <div class="mb-3">
                                <label class="form-label">Dictionary</label>
                                <select v-model="form.parameters.dictionary" class="form-select">
                                    <option value="GoogleTranslator">GoogleTranslator</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true" ref="deleteConfirmModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the article: <strong>"[[ deleteArticleTitle ]]"</strong>?</p>
                    <div class="alert alert-danger" v-if="deleteErrorMessage" role="alert">
                        [[ deleteErrorMessage ]]
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" @click="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
new Vue({
    el: '#profile-app',
    delimiters: ['[[', ']]'],
    data: function() {
        let data = {
            articles: [],
            aiModels: [],
            predefinedUrls: [
                'https://www.merriam-webster.com/dictionary/{term}',
                'https://translate.google.com/?sl=en&tl=sr&text={term}&op=translate',
                'https://glosbe.com/sr/ru/{term}',
                'https://dictionary.cambridge.org/spellcheck/english/?q={term}',
                'https://www.oed.com/search/dictionary/?scope=Entries&q={term}'
            ],
            form: {
                id: null,
                title: '',
                type: '',
                parameters: {}
            },
            showTitleField: true,
            modalTitle: '',
            allLanguages: [],
            currentLanguageId: null,
            userLanguageId: null,
            inlineTranslation: {},
            errorMessage: '',
            deleteArticleId: null,
            deleteArticleTitle: '',
            deleteErrorMessage: '',
        };

        try {
            data.articles = JSON.parse('{{ articles|escapejs }}' || '[]');
        } catch (e) {
            console.error('Error parsing articles:', e);
        }

        try {
            data.allLanguages = JSON.parse('{{ all_languages|escapejs }}' || '[]');
        } catch (e) {
            console.error('Error parsing languages:', e);
        }

        try {
            data.inlineTranslation = JSON.parse('{{ inline_translation|escapejs }}' || '{}');
        } catch (e) {
            console.error('Error parsing inline translation:', e);
        }

        data.currentLanguageId = '{{ default_profile.language.google_code }}' || null;
        data.userLanguageId = '{{ default_profile.user_language.google_code }}' || null;

        return data;
    },
    mounted: function() {
        this.loadAIModels();
        this.loadArticles();
    },
    methods: {
        changeLanguage() {
            fetch('{% url "api_get_profile_for_language" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ language_id: this.currentLanguageId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.articles = data.articles;
                    this.inlineTranslation = data.inline_translation;
                    this.userLanguageId = data.user_language_id;
                } else {
                    alert('Failed to change profile');
                }
            });
        },
        changeUserLanguage() {
            fetch('{% url "api_update_user_language" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    language_id: this.userLanguageId,
                    profile_language_id: this.currentLanguageId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    alert('Failed to update user language: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating user language');
            });
        },
        openModal(action, article = null) {
            this.resetForm();
            this.errorMessage = '';
            this.modalTitle = action === 'add' ? 'Add New Article' : 'Edit Article';
            if (article) {
                this.form = JSON.parse(JSON.stringify(article));
                this.form.id = article.id;
                // Ensure correct parameters structure
                if (this.form.type === 'Site') {
                    this.form.parameters = {
                        url: this.form.parameters.url || '',
                        window: this.form.parameters.window || false
                    };
                } else if (this.form.type === 'Dictionary') {
                    this.form.parameters = {
                        dictionary: this.form.parameters.dictionary || ''
                    };
                }
                this.showTitleField = true;
            } else {
                this.showTitleField = true;
            }
            this.updateParameters();
            new bootstrap.Modal(this.$refs.articleModal).show();
        },
        resetForm() {
            this.form = {
                id: null,
                title: '',
                type: '',
                parameters: {}
            };
        },
        loadAIModels() {
            fetch('{% url "get_models" %}')
                .then(response => response.json())
                .then(data => {
                    this.aiModels = data.models;
                })
                .catch(error => {
                    console.error('Error loading AI models:', error);
                });
        },
        formatUrl(url) {
            try {
                let domain = new URL(url).hostname;
                domain = domain.replace(/^www\./, '');
                domain = domain.replace(/\.com$/, '');
                return domain;
            } catch (e) {
                return url;  // Return the original string if it's not a valid URL
            }
        },
       getModelTitle(modelKey) {
            const model = this.aiModels.find(m => m.key === modelKey);
            return model ? model.title : modelKey;
        },
        updateParameters() {
            if (!this.form.title) {
                this.form.title = this.generateTitle(this.form.type);
            }
            if (this.form.type === 'Site') {
                this.form.parameters = this.form.parameters || {
                    url: '',
                    window: false
                };
            } else if (['Translate', 'Sentence', 'Explain', 'Examples', 'Lexical'].includes(this.form.type)) {
                fetch('{% url "get_models" %}')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.aiModels = data.models;
                        console.log('AI Models:', this.aiModels);
                        // Set default model if not already set
                        if (!this.form.parameters || !this.form.parameters.model) {
                            this.form.parameters = this.form.parameters || {};
                            this.form.parameters.model = this.aiModels.length > 0 ? this.aiModels[0].key : '';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching models:', error);
                        this.aiModels = [];
                    });
            } else if (this.form.type === 'Dictionary') {
                this.form.parameters = this.form.parameters || {
                    dictionary: ''
                };
            }
        },
        generateTitle(type) {
            let title = type;
            if (type === 'Site') {
                const url = this.form.parameters.url;
                if (url) {
                    title = new URL(url).hostname;
                }
            } else if (type === 'Dictionary') {
                title = this.form.parameters.dictionary;
            }

            let uniqueTitle = title;
            let counter = 1;
            while (this.articles.some(a => a.title === uniqueTitle)) {
                uniqueTitle = `${title} ${counter}`;
                counter++;
            }
            return uniqueTitle;
        },
        saveArticle() {
            const action = this.form.id ? 'edit' : 'add';
            const isInlineTranslation = !this.showTitleField;

            let url = isInlineTranslation ? '{% url "save_inline_translation" %}' : '{% url "manage_lexical_article" %}';
            let data;

            if (isInlineTranslation) {
                data = { type: this.form.type, parameters: this.form.parameters, language_id: this.currentLanguageId };
            } else {
                // Ensure correct parameters for each type
                if (this.form.type === 'Site') {
                    this.form.parameters = {
                        url: this.form.parameters.url || '',
                        window: this.form.parameters.window || false
                    };
                } else if (this.form.type === 'Dictionary') {
                    this.form.parameters = {
                        dictionary: this.form.parameters.dictionary || ''
                    };
                }
                data = { action, ...this.form, language_id: this.currentLanguageId };
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (isInlineTranslation) {
                        this.inlineTranslation = data.inline_translation;
                    } else {
                        this.loadArticles();
                    }
                    const modal = bootstrap.Modal.getInstance(this.$refs.articleModal);
                    modal.hide();
                } else {
                    this.errorMessage = `An error occurred while saving the article: ${data.message || 'An error occurred'}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.errorMessage = `An error occurred while saving the article: ${error.message || 'Unknown error'}`;
            });
        },
        deleteArticle(id) {
            const article = this.articles.find(a => a.id === id);
            if (article) {
                this.deleteArticleId = id;
                this.deleteArticleTitle = article.title;
                this.deleteErrorMessage = '';
                new bootstrap.Modal(this.$refs.deleteConfirmModal).show();
            } else {
                console.error('Article not found');
                // Optionally, show an error message to the user
            }
        },
        confirmDelete() {
            fetch('{% url "manage_lexical_article" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    action: 'delete',
                    id: this.deleteArticleId,
                    language_id: this.currentLanguageId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.loadArticles();
                    bootstrap.Modal.getInstance(this.$refs.deleteConfirmModal).hide();
                } else {
                    this.deleteErrorMessage = data.message || 'An error occurred while deleting the article';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.deleteErrorMessage = 'An error occurred while deleting the article';
            });
        },
        editInlineTranslation() {
            this.resetForm();
            this.errorMessage = '';
            this.showTitleField = false;
            this.modalTitle = 'Edit In-line Translation';
            this.form.type = this.inlineTranslation.type;

            // Set up parameters based on the type
            if (this.form.type === 'Site') {
                this.form.parameters = {
                    url: this.inlineTranslation.parameters.url || '',
                    window: this.inlineTranslation.parameters.window || false
                };
            } else if (this.form.type === 'Dictionary') {
                this.form.parameters = {
                    dictionary: this.inlineTranslation.parameters.dictionary || ''
                };
            } else {
                this.form.parameters = JSON.parse(JSON.stringify(this.inlineTranslation.parameters));
            }

            new bootstrap.Modal(this.$refs.articleModal).show();
        },
        loadArticles() {
            fetch(`{% url "api_profile" %}?language_id=${this.currentLanguageId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Server response is not valid JSON:', text);
                        throw new Error('The server response is not valid JSON');
                    }
                })
                .then(data => {
                    this.articles = data.articles;
                })
                .catch(error => {
                    console.error('Error loading articles:', error);
                    alert('Failed to load articles. Please try again.');
                });
        },
    }
});
</script>

{% endblock %}
